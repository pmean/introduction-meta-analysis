---
title: "Introduction to meta-analysis"
author: "Steve Simon"
date: "11/14/2018"
graphics: yes
output: html_document
---

```{r prelims, echo=FALSE}
library(knitr)
opts_chunk$set(echo=FALSE, fig.width=6.5, fig.height=4.5)
library(magrittr)
suppressMessages(suppressWarnings(library(metafor)))
bcg <- get(data(dat.bcg))
los <- get(data(dat.normand1999))
```

## Overview

This presentation will show how to use base R functions to reproduce the forest plot and funnel plot that is produced by the metafor package. It will also try to motivate how you should interpret patterns in these plots.

## BCG description

"Results from 13 studies examining the effectiveness of the Bacillus Calmette-Guerin (BCG) vaccine against tuberculosis."

Available at https://rdrr.io/cran/metafor/man/dat.colditz1994.html

## BCG data, first three columns

```{r bcg-list1}
bcg[ , c("trial", "author", "year")]
```

## BCG data, last six columns

```{r bcg-list2}
bcg[ , c("tpos", "tneg", "cpos", "cneg", "ablat", "alloc")]
```

```{r bcg-fe, comment=""}
bcg_fixed_effects <- rma(
  method="FE",
  measure="OR", 
  ai=tpos, bi=tneg, 
  ci=cpos, di=cneg,
  data=bcg, slab=paste(author, year))
bcg_fixed_effects_text <-
  capture.output(bcg_fixed_effects)
cat(bcg_fixed_effects_text, sep="\n")
forest(bcg_fixed_effects)
```

## Experiments

```{r experiments,fig.width=6.5, fig.height=4.5}
par(mar=c(4.1, 0, 0, 0))
forest(bcg_fixed_effects)
```

Here are the results for the first study, listed in a two by two table. A positive result is bad, indicating that the vaccine did not work.

```{r table}
v <- bcg[1, c("tpos", "tneg", "cpos", "cneg")]
m <- matrix(v, nrow=2, byrow=TRUE)
dimnames(m) <- list(
  c("T", "C"),
  c("Pos", "Neg")
)
m
odds <- unlist(m[, 1])/unlist(m[, 2])
or <- odds[1]/odds[2]
log.or <- log(or)
odds <- round(odds, 3)
or <- round(or, 3)
log.or <- round(log.or, 3)
```

Calculate the odds for each row.

```{r odds, echo=FALSE}
cat(paste(v[1], "/", v[2], "=", odds[1]))
cat("\n")
cat(paste(v[3], "/", v[4], "=", odds[2]))
```
The ratio of these two odds is the odds ratio.

```{r or, echo=FALSE}
cat(paste(odds[1], "/", odds[2], "=", or))
```

The underlying distribution of the odds ratio is almost always skewed right and bounded below by zero, so you should consider a log transformation.

```{r log-or, echo=FALSE}
cat(paste0("log(", or, ")=", log.or))
```

```{r forest-theta1}
forest(bcg_fixed_effects)
text(-0.94, 13.5, "-0.94", col="red")
```

The variance of the log odds ratio is approximately

$\frac{1}{n_{11}} + \frac{1}{n_{12}} + \frac{1}{n_{21}} + \frac{1}{n_{22}}$

where n11, n12, etc. are the count of each cell in the two by two table. For the first study, you get

```{r v, echo=FALSE}
var <- round(sum(1/v), 3)
cat(paste0(paste0("1/", v, collapse=" + "), " = ", var))
```

The approximate confidence interval for the log odds is

```{r ci, echo=FALSE}
lo <- round(log.or-1.96*sqrt(var), 3)
hi <- round(log.or+1.96*sqrt(var), 3)
cat(paste0(log.or, "-1.96*", var,"=", lo))
cat(paste0(log.or, "+1.96*", var,"=", hi))
```

These limits include the value of zero, so this particular study failed to reject the null hypothesis.

```{r forest-ci1}
forest(bcg_fixed_effects)
text(-2.11, 13.5, "-2.11", col="red")
text( 0.23, 13.5,  "0.23", col="red")
```

The log odds ratios and variances for the full data set are listed below.

```{r, full-log-or, echo=FALSE}
bcg_or <- escalc(
  measure="OR", data=dat.bcg,
  ai=tpos, bi=tneg, 
  ci=cpos, di=cneg)
b <- data.frame(y=round(bcg_or$yi,2), w=round(1/bcg_or$vi,1))
b
y <- round(sum(b$y*b$w)/sum(b$w), 2)
```

```{r save-everything, results=FALSE}
save.image(file="../data/calculations.RData")
```